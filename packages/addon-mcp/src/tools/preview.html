<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<style></style>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}
			html[data-theme='light'] {
				color-scheme: light;
			}
			html[data-theme='dark'] {
				color-scheme: dark;
			}
			html,
			body {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				background-color: var(--color-background-secondary);
			}
			body {
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}
			:root {
				/*
				These are fallback values, if the MCP client doesn't set them.
				See https://github.com/modelcontextprotocol/ext-apps/blob/main/specification/draft/apps.mdx#theming
				*/
				--color-text-primary: light-dark(black, white);
				--color-border-primary: light-dark(#ccc, #444);
				--color-background-secondary: light-dark(#f9f9f9, #1e1e1e);
				--font-sans:
					-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Oxygen-Sans',
					Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
				--font-heading-xs-size: 1rem;
				--font-heading-xs-line-height: 1.25;
				--border-width-regular: 1px;
			}
			.story-heading {
				font-family: var(--font-sans);
				font-size: var(--font-heading-xs-size);
				line-height: var(--font-heading-xs-line-height);
				color: var(--color-text-primary);
				padding: 0.5rem 0;
			}
			.story-iframe {
				background-color: white;
				border: var(--border-width-regular) solid var(--color-border-primary);
			}
		</style>
		<template id="preview-template">
			<article>
				<h1 class="story-heading"></h1>
				<iframe class="story-iframe"></iframe>
			</article>
		</template>
		<script type="module">
			const STORYBOOK_MCP_SIZE_CHANGED = 'storybook-mcp:size-changed';
			const MCP_APP_PARAM = 'mcp-app';

			// Adapted from https://github.com/MCP-UI-Org/mcp-ui/blob/fd89e2942eb7148d83245397be0b6ad34ce538b0/sdks/typescript/server/src/adapters/mcp-apps/adapter-runtime.ts
			/**
			 * Current protocol version - must match LATEST_PROTOCOL_VERSION from ext-apps
			 * @see https://github.com/modelcontextprotocol/ext-apps
			 */
			const LATEST_PROTOCOL_VERSION = '2025-11-21';

			/**
			 * MCP Apps SEP protocol method constants
			 * These match the `method` field values from @modelcontextprotocol/ext-apps type definitions:
			 * - McpUiInitializeRequest: "ui/initialize"
			 * - McpUiInitializedNotification: "ui/notifications/initialized"
			 * - McpUiToolInputNotification: "ui/notifications/tool-input"
			 * - McpUiToolInputPartialNotification: "ui/notifications/tool-input-partial"
			 * - McpUiToolResultNotification: "ui/notifications/tool-result"
			 * - McpUiHostContextChangedNotification: "ui/notifications/host-context-changed"
			 * - McpUiSizeChangedNotification: "ui/notifications/size-changed"
			 * - McpUiResourceTeardownRequest: "ui/resource-teardown"
			 *
			 * @see https://github.com/modelcontextprotocol/ext-apps/blob/main/src/spec.types.ts
			 */
			const METHODS = {
				// Lifecycle
				INITIALIZE: 'ui/initialize',
				INITIALIZED: 'ui/notifications/initialized',

				// Tool data (Host -> Guest)
				TOOL_INPUT: 'ui/notifications/tool-input',
				TOOL_INPUT_PARTIAL: 'ui/notifications/tool-input-partial',
				TOOL_RESULT: 'ui/notifications/tool-result',
				TOOL_CANCELLED: 'ui/notifications/tool-cancelled',

				// Context & UI
				HOST_CONTEXT_CHANGED: 'ui/notifications/host-context-changed',
				SIZE_CHANGED: 'ui/notifications/size-changed',
				RESOURCE_TEARDOWN: 'ui/resource-teardown',

				// Standard MCP methods
				TOOLS_CALL: 'tools/call',
				NOTIFICATIONS_MESSAGE: 'notifications/message',
				OPEN_LINK: 'ui/open-link',
				MESSAGE: 'ui/message',
			};

			// Adapted from https://github.com/modelcontextprotocol/ext-apps/blob/main/specification/draft/apps.mdx#transport-layer

			let nextId = 1;
			function sendHostRequest(method, params) {
				const id = nextId++;
				const { promise, resolve, reject } = Promise.withResolvers();

				window.parent.postMessage({ jsonrpc: '2.0', id, method, params }, '*');

				window.addEventListener('message', function listener(event) {
					const data = event.data;
					if (event.data?.id !== id) {
						return;
					}
					window.removeEventListener('message', listener);
					if (event.data?.result) {
						resolve(event.data?.result);
					} else if (event.data?.error) {
						reject(new Error(event.data.error));
					}
				});
				return promise;
			}

			function sendHostNotification(method, params) {
				window.parent.postMessage({ jsonrpc: '2.0', method, params }, '*');
			}

			function onHostNotification(method, handler) {
				window.addEventListener('message', function listener(event) {
					if (event.data?.method === method) {
						handler(event.data.params);
					}
				});
			}

			const initializeResult = await sendHostRequest(METHODS.INITIALIZE, {
				appInfo: {
					name: 'storybook-story-preview',
					version: '1.0.0',
				},
				appCapabilities: {},
				protocolVersion: LATEST_PROTOCOL_VERSION,
			});
			applyHostStyles(initializeResult?.hostContext);

			onHostNotification(METHODS.TOOL_RESULT, loadStoryIframes);
			onHostNotification(METHODS.HOST_CONTEXT_CHANGED, applyHostStyles);
			sendHostNotification(METHODS.INITIALIZED, {});

			// Listen for size messages from Storybook iframes (height only to avoid feedback loops)
			window.addEventListener('message', function (event) {
				if (event.data?.type !== STORYBOOK_MCP_SIZE_CHANGED) {
					return;
				}

				// Find the iframe that sent this message
				const iframes = document.querySelectorAll('.story-iframe');
				let hasResizedIframes = false;
				for (const iframe of iframes) {
					if (iframe.contentWindow === event.source) {
						iframe.style.height = event.data.height + 'px';
						hasResizedIframes = true;
						break;
					}
				}
				if (hasResizedIframes) {
					resizeApp();
				}
			});

			function applyHostStyles(hostContext) {
				console.log('Applying host styles:', { hostContext });
				if (hostContext?.theme) {
					document.documentElement.setAttribute(
						'data-theme',
						hostContext.theme,
					);
				}
				if (!hostContext?.styles?.variables) {
					return;
				}
				for (const [key, value] of Object.entries(
					hostContext.styles.variables,
				).filter(([, value]) => !!value)) {
					document.documentElement.style.setProperty(key, value);
				}
				resizeApp();
			}

			function resizeApp(event) {
				sendHostNotification(METHODS.SIZE_CHANGED, {
					width: document.documentElement.scrollWidth,
					height: document.documentElement.scrollHeight,
				});
			}

			function loadStoryIframes(params) {
				if (
					!params.structuredContent?.stories ||
					params.structuredContent.stories.length === 0
				) {
					console.warn('No preview URLs found in tool result.');
					return;
				}

				const template = document.getElementById('preview-template');

				for (const { title, name, previewUrl } of params.structuredContent
					.stories) {
					const clone = template.content.cloneNode(true);
					const article = clone.querySelector('article');
					const heading = clone.querySelector('h1');
					const iframe = clone.querySelector('iframe');

					heading.textContent = `${title} - ${name}`;

					// Set a reasonable default size while waiting for the iframe to report its size
					iframe.style.width = '100%';
					iframe.style.height = '200px';

					const iframeSrc = previewUrl.replace(
						'/?path=/story/',
						'/iframe.html?id=',
					);
					// Add MCP App param to enable size reporting in Storybook's preview.ts
					const url = new URL(iframeSrc);
					url.searchParams.set(MCP_APP_PARAM, 'true');
					iframe.src = url.toString();

					document.body.appendChild(article);
				}
				resizeApp();
			}
		</script>
	</head>
	<body></body>
</html>

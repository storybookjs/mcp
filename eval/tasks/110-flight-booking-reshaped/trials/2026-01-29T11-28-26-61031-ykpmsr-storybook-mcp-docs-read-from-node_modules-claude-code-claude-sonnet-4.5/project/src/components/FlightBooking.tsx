import React, { useState } from "react";
import {
  Autocomplete,
  Button,
  Calendar,
  Popover,
  ToggleButton,
  ToggleButtonGroup,
  View,
} from "reshaped";

interface Airport {
  code: string;
  name: string;
}

const airports: Airport[] = [
  { code: "SYD", name: "Sydney Airport, Australia" },
  { code: "MEL", name: "Melbourne Airport (Tullamarine), Australia" },
  { code: "LAX", name: "Los Angeles International Airport, USA" },
  { code: "JFK", name: "John F. Kennedy International Airport, New York, USA" },
  { code: "LHR", name: "Heathrow Airport, London, UK" },
  { code: "CDG", name: "Charles de Gaulle Airport, Paris, France" },
  { code: "ATL", name: "Hartsfieldâ€“Jackson Atlanta International Airport, USA" },
  { code: "DXB", name: "Dubai International Airport, UAE" },
  { code: "HKG", name: "Hong Kong International Airport, Hong Kong" },
  { code: "BNE", name: "Brisbane Airport, Australia" },
  { code: "PER", name: "Perth Airport, Australia" },
  { code: "DFW", name: "Dallas Fort Worth International Airport, USA" },
];

interface FlightBookingProps {
  onSubmit?: () => void;
}

const FlightBooking: React.FC<FlightBookingProps> = ({ onSubmit }) => {
  const [tripType, setTripType] = useState<string[]>(["return"]);
  const [fromAirport, setFromAirport] = useState("");
  const [toAirport, setToAirport] = useState("");
  const [departureDate, setDepartureDate] = useState<Date | null>(null);
  const [returnDate, setReturnDate] = useState<Date | null>(null);
  const [fromInputValue, setFromInputValue] = useState("");
  const [toInputValue, setToInputValue] = useState("");

  const isReturnTrip = tripType.includes("return");

  const filteredFromAirports = airports.filter(
    (airport) =>
      airport.code.toLowerCase().includes(fromInputValue.toLowerCase()) ||
      airport.name.toLowerCase().includes(fromInputValue.toLowerCase())
  );

  const filteredToAirports = airports.filter(
    (airport) =>
      airport.code.toLowerCase().includes(toInputValue.toLowerCase()) ||
      airport.name.toLowerCase().includes(toInputValue.toLowerCase())
  );

  const formatDate = (date: Date | null) => {
    if (!date) return null;
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  };

  const today = new Date();
  today.setHours(0, 0, 0, 0);

  return (
    <View gap={4} padding={4}>
      <View gap={3}>
        <ToggleButtonGroup
          value={tripType}
          onChange={({ value }) => {
            setTripType(value);
            if (!value.includes("return")) {
              setReturnDate(null);
            }
          }}
          selectionMode="single"
        >
          <ToggleButton value="oneway">One Way</ToggleButton>
          <ToggleButton value="return">Return</ToggleButton>
        </ToggleButtonGroup>

        <View direction="row" gap={2}>
          <View.Item grow>
            <Autocomplete
              placeholder="From"
              value={fromInputValue}
              onInput={(e) => setFromInputValue(e.value)}
              onItemSelect={({ value }) => {
                setFromAirport(value);
                setFromInputValue(value);
              }}
            >
              {filteredFromAirports.map((airport) => (
                <Autocomplete.Item
                  key={airport.code}
                  value={`${airport.code}: ${airport.name}`}
                >
                  {airport.code}: {airport.name}
                </Autocomplete.Item>
              ))}
            </Autocomplete>
          </View.Item>

          <View.Item grow>
            <Autocomplete
              placeholder="To"
              value={toInputValue}
              onInput={(e) => setToInputValue(e.value)}
              onItemSelect={({ value }) => {
                setToAirport(value);
                setToInputValue(value);
              }}
            >
              {filteredToAirports.map((airport) => (
                <Autocomplete.Item
                  key={airport.code}
                  value={`${airport.code}: ${airport.name}`}
                >
                  {airport.code}: {airport.name}
                </Autocomplete.Item>
              ))}
            </Autocomplete>
          </View.Item>
        </View>

        <View direction="row" gap={2}>
          <View.Item grow>
            <Popover>
              <Popover.Trigger>
                <Button fullWidth>
                  {departureDate ? formatDate(departureDate) : "Departure Date"}
                </Button>
              </Popover.Trigger>
              <Popover.Content>
                <Calendar
                  value={departureDate}
                  onChange={({ value }) => {
                    setDepartureDate(value);
                    if (
                      isReturnTrip &&
                      returnDate &&
                      value &&
                      value > returnDate
                    ) {
                      setReturnDate(null);
                    }
                  }}
                  min={today}
                />
              </Popover.Content>
            </Popover>
          </View.Item>

          {isReturnTrip && (
            <View.Item grow>
              <Popover>
                <Popover.Trigger>
                  <Button fullWidth>
                    {returnDate ? formatDate(returnDate) : "Return Date"}
                  </Button>
                </Popover.Trigger>
                <Popover.Content>
                  <Calendar
                    value={returnDate}
                    onChange={({ value }) => setReturnDate(value)}
                    min={departureDate || today}
                  />
                </Popover.Content>
              </Popover>
            </View.Item>
          )}
        </View>

        <Button onClick={onSubmit} fullWidth variant="solid" color="primary">
          Search Flights
        </Button>
      </View>
    </View>
  );
};

export default FlightBooking;
